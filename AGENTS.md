# 算数「考え方」コーチングアプリ 要件定義書

## 1. プロダクト概要
**「答え」ではなく「考え方（プロセス）」を教える、親子で使う算数学習アプリ。**
AIは「先生」ではなく、子供の隣で一緒に考える「パートナー（お兄さん・お姉さん）」として振る舞う。
画像を読み込むことで、子供が自力で解けるようになるための「着眼点」と「思考のステップ」を提示する。

## 2. ターゲットユーザー
* **メイン:** 小学校高学年（特に4年生前後）の児童
* **サブ:** 子供に算数を教えたいが、教え方がわからない親

## 3. 基本体験フロー (UX Flow)

### Phase 1: 問題入力
* カメラまたはアルバムから算数の問題（文章題、図形など）をアップロード。
* AIが画像内の情報を読み取り、テキスト化して認識する。

### Phase 2: ステップ学習 (Step-by-Step Learning)
* いきなり答えを出さず、解法を複数のカード（ステップ）に分割して表示する。
* **画面UI構成:**
    * **ヘッダー:** 「まえのステップの答え（振り返り）」を表示（Step 2以降）。
    * **メインカード:**
        * **observation (着眼点):** 図のどこを見るか指し示す。
        * **approach (作戦):** どのような考え方・計算を使うか（※ネタバレ厳禁）。
        * **guidance (問いかけ):** 次のアクションを促す。
    * **アクションボタン:** ステップ進行ボタン（後述）。

### Phase 3: 完了と達成 (Completion)
* 全てのステップを終えると「最後まで考えられたね！」という賞賛画面を表示。
* ここで初めて「思考の完了」を承認する。

### Phase 4: 答え合わせ (Answer Reveal)
* 任意のアクションとして「答えを見る」ボタンを配置。
* 正解の数値と、その根拠を自然な会話形式で表示する。

---

## 4. フロントエンド実装要件 (Flutter)

### 4.1. ボタン文言の動的制御
ステップの進行状況に応じて、ボタンのラベルとアイコンを出し分ける。

| 条件 (Condition) | ボタン文言 (Text) | アイコン (Icon) | 意図 (Intent) |
| :--- | :--- | :--- | :--- |
| **途中のステップ**<br>(`index < length - 1`) | **「考えたよ！（つぎへ）」** | `arrow_forward` | 「書く」ことより「考える」ことを重視し、思考完了を宣言させる。 |
| **最後のステップ**<br>(`index == length - 1`) | **「最後まで考えた！」** | `check` / `sentiment_satisfied` | 次の完了画面（賞賛）へと文脈をつなげる。 |

### 4.2. 「まえのステップの答え」の表示制御
* **Step 1:** 非表示（null）。
* **Step 2以降:** カード上部、または別枠として目立つように表示。「さっき考えたことの正解」として安心感を与える。

---

## 5. AI/プロンプトエンジニアリング要件 (Gemini)

AI（Gemini）には以下の厳格なルールを適用し、出力の「揺れ」を防止する。

### 5.1. キャラクター設定 (Tone & Manner)
* **役割:** 親しみやすいパートナー（お兄さん・お姉さん）。
* **禁止事項:** 命令口調（〜しましょう、〜しなさい）、講義口調（〜となります、〜を表します）。
* **推奨事項:** 問いかけ口調（〜を見てみて、〜だね、〜かな？）。

### 5.2. JSON出力構造とフィールド定義
出力は以下のJSON構造に準拠する。

```json
{
  "problems": [
    {
      "problem_text": "（図中の情報をすべて言語化した問題文）",
      "steps": [
        {
          "step_label": "ステップ1",
          "observation": "（着眼点：具体的に図のどこを見るか）",
          "approach": "（作戦：計算の概念。※具体的な数式ネタバレは禁止）",
          "guidance": "（問いかけ：行動を促す。最後なら「仕上げだよ」と添える）",
          "prev_answer": null
        },
        {
          "step_label": "ステップ2",
          "observation": "...",
          "approach": "...",
          "guidance": "...",
          "prev_answer": "（振り返り：状況＋式＋答えのセット）"
        }
      ],
      "final_answer": "（結論：機械的なタグを使わず、会話形式で結論と根拠を述べる）"
    }
  ]
}

### 5.3. 生成ロジックの重要ルール

#### A. ネタバレ防止 (No Spoilers)
* `approach` フィールドにおいて、「150÷6をしよう」のように具体的な数字を使った式の指示を禁止する。
* 「合計を個数でわろう」のように**概念**を伝えること。

#### B. ステップ分割の原則 (Separation Rule)
* 「複数の計算をして比較する問題」の場合、**1ステップにつき1つの計算対象**に絞る。
* ×悪い例：ステップ2で「Bを計算してAと比べよう」
* 〇良い例：ステップ2「Bを計算しよう」→ ステップ3「AとBを比べよう」

#### C. 前のステップの振り返り (Rich Recap)
* `prev_answer` は単なる数値（2.5）ではなく、文脈を含める。
* フォーマット：「（状況）だったね。だから（式）をして、（答え）になったね。」

#### D. 最終回答の自然言語化
* `final_answer` に `【理由】` や `【計算式】` などのタグを使用しない。
* 1行目でズバリ答えを言い、2行目以降で優しく解説する会話形式にする。

## 6. ユースケース別シナリオ

### シナリオ：比較問題（どっちが混んでいる？）
1.  **Step 1:** 1組のデータを着眼させ、割り算の概念を提示。「考えたよ！」
2.  **Step 2:** ヘッダーに「1組は2.5ひきだったね」と表示。2組の計算を促す。「考えたよ！」
3.  **Step 3 (Last):** ヘッダーに「2組は3ひきだったね」と表示。「さあ、2.5と3を比べて結論を出そう！」と誘導。「最後まで考えた！」
4.  **Completion:** 「最後まで考えられたね！」画面。
5.  **Answer:** 「答えは2組だよ！ 3ひきの方が数字が大きいからね」を表示。