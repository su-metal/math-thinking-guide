# AI算数アプリ｜モデル切替・検証設計（最終決定）

本ドキュメントは、これまでの実証（Flash誤答／Pro正答／Pro誤答事例）を踏まえた**最終的な意思決定と実装指針**をまとめたものです。

---

## 1. 基本方針（思想）

- **無料／有料で解の質は分けない**
- Proは「常用」ではなく **例外処理（最後の手段）**
- モデル切替だけでは品質保証にならないため、**検証レイヤーを必須**とする
- 競技問題（算数オリンピック等）かどうかは **難易度判断に直接使わない**

---

## 2. 使用モデル

| 役割 | モデル | 用途 |
|---|---|---|
| M1 | Gemini 2.5 Flash | 通常問題・最初の試行 |
| M2 | Gemini 3 Flash Preview | 精度保険・検算役 |
| M3 | Gemini 3 Pro Preview | 難問対応（チケット制） |

※ 検証（Verifier）には **M2を再利用**する（コスト抑制）

---

## 3. 難問スコア difficulty_score（0〜10）

**Flashが落としやすい構造を強く評価するスコア**

### 基本加点
- 条件が多い（角・辺・長さ・面積など3つ以上）: +1
- 多段構造（(1)(2)、既知→別量）: +1
- 図形が重い（交点・四角形・補助線前提）: +1

### Flash落としやすさ（強）
- 四角形以上 + 複数角条件: +2
- 角度条件 + 辺比／長さ条件が混在: +1
- 対角線・交点が主役: +1

#### 【追加・確定】強トリガー
- **三角形の2辺に正方形を作る + 交点 + 面積連鎖**: **+3**

### 加点しない（Flashが得意）
- 正多角形・正方形の対称／回転／合同で閉じる
- 角度の和差だけで解ける
- 面積保存・等積変形で一本道

※ 競技フラグ（算数オリンピック等）は **加点しない**（別管理）

---

## 4. 解釈分岐スコア ambiguity_score（0〜10）

**Proでも誤答しやすい「図の解釈が分岐する問題」を検出**

### トリガー
- 図が複数（図1／図2）: +3
- 「色の部分」「塗られた部分」など領域指定: +3
- 「線で結ぶ」「内側を通らない」など制約文: +2
- 正方形が複数・配置変換／回転あり: +2
- 交点・中点など定義点が多数: +1

---

## 5. 出力品質ゲート quality_gate（必須）

モデル出力が以下を**すべて満たす必要あり**:

- JSONとしてパース可能
- 必須キー欠落なし
- ステップ数が規定内
- 禁止ルール違反なし
- **confidence（0〜1）が付与されている**

NGの場合は上位モデルへ（最大2段）

---

## 6. モデルルーティング（基本フロー）

1. **M1（2.5 Flash）**
2. NG or confidence低 → **M2（3 Flash）**
3. M2もNG → **Pro候補**（自動実行しない）

---

## 7. Proチケット提示条件（ユーザー確認必須）

### 条件（すべて満たす）
- Pro会員
- チケット残あり
- 以下のいずれか
  - difficulty_score ≥ 8
  - Flash落としやすさの強加点あり
  - M2のquality_gate NG
  - confidence < 0.65

### 文言（確定）
> この問題は、かなり考える力が必要そうです。  
> さらに精度の高い解析を行うため、Proチケットを1枚使ってじっくり考えますか？

※ **勝手にチケット消費しない**

---

## 8. 検証モード（最重要・必須）

### 検証モードに入る条件
- ambiguity_score ≥ 6
- **M3を使用した場合は自動ON**

### 検証A（軽量）
- M3の答えを **M2で検算**
- 条件充足・論理矛盾・図の一貫性を確認

OK → 採用
NG → 検証Bへ

### 検証B（強）
- M3を**別プロンプトで2回目実行**（独立解法）
  - 座標化ルート
  - 等積／回転／合同ルート
- 答え一致 → 採用
- 不一致 → **確信なし**

※ 追加検証は **チケット消費なし**

---

## 9. 「確信なし」の扱い（UX）

- 答えは断定しない
- 撮り直し／図の境界が見える写真を案内
- 「精密に確認しています」等の表示で課金圧をかけない

---

## 10. 最終結論

- **競技問題 = Pro ではない**
- **Flashが落としやすい構造 + 解釈分岐があるときのみ Pro**
- **Proでも落とす問題は、検証レイヤーで止める**

この設計により、
- APIコスト暴発を防ぎ
- 解の品質を最大化し
- ユーザー納得度の高い課金体験を実現する

---

（本ドキュメントは実装の正として扱う）

